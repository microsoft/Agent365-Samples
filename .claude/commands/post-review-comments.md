# Post Review Comments to GitHub

Post code review findings from a review file (generated by `/review-pr` or `/review-staged`) as comments on the associated GitHub pull request.

## Usage

```
/post-review-comments [REVIEW_FILE_PATH]
```

**Arguments:**
- `REVIEW_FILE_PATH` (optional) - Path to the review file. If omitted, uses the most recent review file in `.codereviews/`.

**Examples:**
- `/post-review-comments` - Post comments from the most recent review
- `/post-review-comments .codereviews/claude-pr187-20260124_120000.md` - Post from specific review file

## Instructions

You are posting code review findings to GitHub as PR comments. Findings with exact line information will be posted as **inline comments** directly on the code. Findings without line info will be posted as regular PR comments.

### Step 1: Locate and Parse the Review File

1. If `$ARGUMENTS` is provided and non-empty, use that as the review file path
2. Otherwise, find the most recent review file:
   ```bash
   ls -t .codereviews/claude-*.md 2>/dev/null | head -1
   ```
   On Windows, use PowerShell:
   ```powershell
   (Get-ChildItem .codereviews/claude-*.md | Sort-Object LastWriteTime -Descending | Select-Object -First 1).FullName
   ```

3. Read the review file completely

4. **Validate the review file**:
   - Must contain "PR Number:" in the metadata section
   - If "PR Number:" is not found or is empty, inform the user this skill only works with PR reviews (not staged reviews) and exit

5. **Extract key information**:
   - **PR Number**: Extract from the `PR Number:` field (e.g., `#187` ‚Üí `187`)
   - **PR Title**: Extract from `PR Title:` field
   - **Approval Status**: Extract from `Final Status:` field
   - **HEAD Commit**: Extract from `HEAD Commit:` field (required for inline comments)

### Step 2: Parse Findings

Parse ALL findings from the review file. Findings are formatted as:

```markdown
#### [CRM-XXX] Issue Title

| Field | Value |
|-------|-------|
| **Identified By** | `agent-name` |
| **File** | `path/to/file.ext` |
| **Line(s)** | 42-58 |
| **Diff Line** | 47 |
| **Diff Side** | RIGHT |
| **Severity** | `medium` |
...

**Description:**
<description text>

**Diff Context:**
<code block>

**Suggestion:**
<suggestion text>
```

For each finding, extract:
- `id`: The CRM-XXX identifier
- `title`: The issue title after the ID
- `identified_by`: From the table
- `file`: From the table
- `lines`: From the table (file line numbers for display)
- `diff_line`: From the table (line number in the diff for inline comments)
- `diff_side`: From the table (`RIGHT` or `LEFT`)
- `severity`: From the table (critical/high/medium/low)
- `description`: The text after **Description:**
- `diff_context`: The code block after **Diff Context:** (if present)
- `suggestion`: The text after **Suggestion:**

**Categorize findings** into two groups:
1. **Inline-capable**: Have valid `file`, `diff_line`, and `diff_side` values
2. **General comments**: Missing line information (will be posted as regular PR comments)

Create a list of all findings to post.

### Step 3: Verify GitHub CLI Version and Authentication

Before posting comments, ensure the GitHub CLI is up-to-date and the correct account is active.

#### 3.1 Check GitHub CLI Version

1. **Get the installed version**:
   ```bash
   gh --version
   ```
   Parse the version number (e.g., `gh version 2.20.2` ‚Üí `2.20.2`)

2. **Check if version supports multi-account switching** (requires v2.40.0+):
   - If version is **2.40.0 or higher**: Continue to step 3.2
   - If version is **below 2.40.0**: Attempt automatic upgrade

3. **Attempt automatic upgrade** (if version < 2.40.0):

   Inform the user you're attempting to upgrade:
   ```
   ‚ö†Ô∏è GitHub CLI version <current_version> detected. Version 2.40.0+ is recommended.
   Attempting automatic upgrade...
   ```

   Try upgrade commands based on the detected platform:

   **Windows**: Try these in order until one succeeds:
   ```powershell
   winget upgrade GitHub.cli --accept-source-agreements --accept-package-agreements
   ```
   If winget fails, try:
   ```powershell
   choco upgrade gh -y
   ```
   If choco fails, try:
   ```powershell
   scoop update gh
   ```

   **macOS**:
   ```bash
   brew upgrade gh
   ```

   **Linux**:
   ```bash
   sudo apt update && sudo apt upgrade gh -y
   ```

4. **Verify upgrade succeeded**:
   ```bash
   gh --version
   ```

   - If version is now **2.40.0 or higher**: Report success and continue to step 3.2
     ```
     ‚úÖ GitHub CLI upgraded to <new_version>
     ```

   - If upgrade failed or version is still below 2.40.0: Provide manual instructions and exit
     ```
     ‚ö†Ô∏è Automatic upgrade was not successful. Current version: <version>

     Please upgrade manually using one of these methods:

     | Platform | Command |
     |----------|---------|
     | Windows (winget) | `winget upgrade GitHub.cli` |
     | Windows (scoop) | `scoop update gh` |
     | Windows (choco) | `choco upgrade gh` |
     | macOS (Homebrew) | `brew upgrade gh` |
     | Linux (apt) | `sudo apt update && sudo apt upgrade gh` |

     After upgrading, run this command again.
     ```

     Exit the skill after providing manual instructions.

#### 3.2 Check Current GitHub Account

1. **Get the current authenticated user**:
   ```bash
   gh auth status 2>&1
   ```
   Parse the username from "Logged in to github.com as USERNAME"

2. **Detect Enterprise Managed User (EMU) accounts**:

   EMU accounts typically follow the pattern `username_orgname` (e.g., `johanb_microsoft`).

   Check if the username matches EMU patterns:
   - Contains an underscore AND the part after the last underscore is a known enterprise suffix: `microsoft`, `msft`, `github`, `google`, `meta`, `amazon`, `aws`
   - Or more generally: contains `_` followed by an alphabetic string (not numbers)

3. **If EMU account detected**:

   a. Check available accounts:
      ```bash
      gh auth status 2>&1
      ```
      Look for multiple accounts listed under github.com

   b. If multiple accounts are available, list them and prompt the user:
      ```
      ‚ö†Ô∏è EMU account detected: <username>
      EMU accounts cannot post comments to public repositories.

      Available accounts:
      1. johanb_microsoft (EMU - active)
      2. johanb (public)

      Would you like to switch to a non-EMU account to post comments?
      ```

      If user confirms, run:
      ```bash
      gh auth switch --user <non_emu_username>
      ```

   c. If only one account (the EMU) is available, offer to help add a public account:

      ```
      ‚ö†Ô∏è EMU account detected: <username>
      EMU accounts cannot post comments to public repositories.

      No alternative accounts found. Would you like to add a public GitHub account now?
      ```

      **If user agrees to add a public account:**

      1. **Inform the user what will happen:**
         ```
         I'll start the GitHub authentication process. A browser window will open for you to sign in with your public GitHub account.
         ```

      2. **Run the login command:**
         ```bash
         gh auth login --hostname github.com --git-protocol https --web
         ```

         The `--web` flag opens a browser for authentication, which is the most reliable method.

      3. **Wait for the command to complete** and check the exit code.

      4. **Verify the new account was added:**
         ```bash
         gh auth status 2>&1
         ```

         Check if there are now multiple accounts listed. Parse the new account username.

      5. **If a new non-EMU account was added:**
         - Report success:
           ```
           ‚úÖ Successfully added GitHub account: <new_username>
           ```
         - Switch to the new account:
           ```bash
           gh auth switch --user <new_username>
           ```
         - Verify the switch:
           ```bash
           gh auth status 2>&1
           ```
         - Report the active account and continue to Step 4:
           ```
           ‚úÖ Switched to account: <new_username>
           ```

      6. **If login failed or no new account was detected:**
         ```
         ‚ö†Ô∏è Could not detect a new GitHub account. This might happen if:
         - The browser authentication was cancelled
         - You authenticated with the same EMU account
         - There was a network issue

         You can try again, or add the account manually:

         1. Open a terminal and run: gh auth login
         2. Choose "GitHub.com"
         3. Choose "HTTPS" for Git protocol
         4. Choose "Login with a web browser"
         5. Sign in with your **public** (non-EMU) GitHub account
         6. Run this command again: /post-review-comments

         After adding the account, you can switch between accounts with:
            gh auth switch
         ```

         Exit the skill after providing manual instructions.

      **If user declines to add a public account:**

      Exit the skill with a message:
      ```
      No problem. You can add a public GitHub account later by running:
         gh auth login

      Then re-run this command to post the review comments.
      ```

4. **If NOT an EMU account**: Continue to step 4.

### Step 4: Verify PR Access and Get Commit SHA

Before posting comments, verify you have access to the PR and get the HEAD commit SHA:

```bash
gh pr view <PR_NUMBER> --json number,state,headRefOid
```

1. If the PR doesn't exist or you don't have access, inform the user and exit.

2. Extract the `headRefOid` (commit SHA) from the response. This is **required** for posting inline comments.
   - If the review file has a `HEAD Commit:` field, verify it matches or use the current one
   - If the commits differ, warn the user that the PR has been updated since the review

3. Get the repository owner and name for API calls:
   ```bash
   gh repo view --json owner,name
   ```

### Step 5: Post Summary Comment

First, post a summary comment on the PR with the overall review results:

```bash
gh pr comment <PR_NUMBER> --body "$(cat <<'EOF'
## ü§ñ Claude Code Review Summary

**Review Date:** <date from review file>
**Approval Status:** <status>

### Findings Summary

| Severity | Count |
|----------|-------|
| Critical | X |
| High | X |
| Medium | X |
| Low | X |

<List each finding ID and title briefly>

---

EOF
)"
```

### Step 6: Post Individual Finding Comments

Post findings in two ways depending on available line information:

#### 6.1 Post Inline Comments (for findings with Diff Line info)

For findings that have `diff_line` and `diff_side` values, post as **inline review comments** using the GitHub API:

```bash
gh api repos/<OWNER>/<REPO>/pulls/<PR_NUMBER>/comments \
  -f body="<comment_body>" \
  -f commit_id="<HEAD_COMMIT_SHA>" \
  -f path="<file_path>" \
  -F line=<diff_line> \
  -f side="<diff_side>"
```

**Comment body format for inline comments** (keep concise - this appears in the code):

```markdown
<severity_emoji> **[<CRM-ID>] <title>**

<description>

**Suggestion:** <suggestion>
```

**Example:**
```bash
gh api repos/microsoft/Agent365-Samples/pulls/187/comments \
  -f body="üü° **[CRM-001] Endpoint URLs still show localhost**

The print statements show hardcoded localhost URLs even in production.

**Suggestion:** Update URLs to use the dynamic host variable." \
  -f commit_id="abc123def456" \
  -f path="python/openai/sample-agent/host_agent_server.py" \
  -F line=48 \
  -f side="RIGHT"
```

#### 6.2 Post Regular Comments (for findings without line info)

For findings missing `diff_line` or `diff_side`, fall back to regular PR comments:

```bash
gh pr comment <PR_NUMBER> --body "$(cat <<'EOF'
### <severity_emoji> [<CRM-ID>] <title>

| | |
|---|---|
| **Severity** | <severity> |
| **File** | `<file>` |
| **Line(s)** | <lines> |
| **Identified By** | <agent> |

#### Description
<description>

#### Diff Context
```<language>
<diff_context>
```

#### Suggestion
<suggestion>
EOF
)"
```

**Severity Emojis:**
- `critical`: üî¥
- `high`: üü†
- `medium`: üü°
- `low`: üîµ

#### 6.3 Handle API Errors

If an inline comment fails, follow this error handling flow:

**Step 1: Analyze the error**

Parse the error response to identify the cause:

| Error Pattern | Likely Cause | Remediation |
|---------------|--------------|-------------|
| `Validation Failed` with `line` | Line number out of range for the diff | Check if line number is correct |
| `Validation Failed` with `path` | File path not found in the diff | Verify file path matches exactly |
| `Validation Failed` with `commit_id` | Commit SHA doesn't match PR head | Re-fetch current HEAD commit |
| `body` too long | Comment exceeds GitHub limits | Truncate the comment body |
| `422 Unprocessable Entity` | General validation error | Check all parameters |
| `401 Unauthorized` | Auth token issue | Re-check authentication |
| `403 Forbidden` | Permission issue | User may not have write access |

**Step 2: Attempt automatic fix (if applicable)**

For fixable errors, attempt to correct and retry:

1. **Line number issues**:
   - Re-fetch the PR diff: `gh pr diff <PR_NUMBER>`
   - Verify the line exists in the current diff
   - If PR was updated, recalculate line numbers

2. **Commit SHA mismatch**:
   - Fetch current HEAD: `gh pr view <PR_NUMBER> --json headRefOid`
   - Warn user: "PR was updated since review. Using current commit."
   - Retry with new commit SHA

3. **Body too long**:
   - Truncate description to fit GitHub's limits
   - Retry with shorter body

**Step 3: If automatic fix fails, ask the user**

If the error cannot be automatically resolved, present options to the user:

```
‚ö†Ô∏è Failed to post inline comment for [CRM-XXX] <title>

Error: <error message>
File: <file_path>
Line: <diff_line>

This might happen because:
- The PR was updated and the line no longer exists at this position
- The file was renamed or removed
- The line number in the review is incorrect

What would you like to do?
```

**Options:**
1. **Post as regular PR comment** - Post the finding as a general PR comment instead of inline
2. **Skip this finding** - Don't post this comment, continue with others
3. **Cancel remaining** - Stop posting and exit (already posted comments remain)

**Step 4: Track the outcome**

Record what happened for each finding:
- `‚úÖ Posted (inline)` - Successfully posted as inline comment
- `‚úÖ Posted (PR comment)` - Posted as regular comment after inline failed
- `‚è≠Ô∏è Skipped` - User chose to skip
- `‚ùå Failed` - Could not post

### Step 7: Update Review File

After successfully posting all comments, update the review file to note that comments were posted:

1. Read the current review file
2. Add a new section after the "Approval Status" section:

```markdown
---

## GitHub Comments

**Posted:** <ISO 8601 timestamp>
**PR:** #<PR_NUMBER>
**Commit:** <HEAD_COMMIT_SHA>
**Comments Posted:** <total_count>

| Finding | Type | Status | Link |
|---------|------|--------|------|
| Summary | PR Comment | ‚úÖ Posted | [View](link) |
| CRM-001 | Inline | ‚úÖ Posted | [View](link) |
| CRM-002 | Inline ‚Üí PR Comment | ‚úÖ Posted (fallback) | [View](link) |
| CRM-003 | PR Comment | ‚úÖ Posted (no line info) | [View](link) |
| CRM-004 | Inline | ‚è≠Ô∏è Skipped (user choice) | - |
...
```

3. Write the updated file

### Step 8: Report Results

Provide a summary to the user:

1. **PR Link**: The URL to the PR where comments were posted
2. **Comments Posted**: Total count broken down by type
3. **Inline vs Regular**: How many were posted inline vs as regular comments
4. **Breakdown by severity**: How many of each type
5. **Any failures**: If any comments failed to post, list them with error details

**Example output:**
```
‚úÖ Successfully posted code review comments to PR #187

üìù Comments Posted: 5
   - 1 Summary comment (PR comment)
   - 2 Inline comments (on specific lines)
   - 1 Inline ‚Üí PR comment (fallback after error)
   - 1 PR comment (no line info available)

‚è≠Ô∏è Skipped: 0

üìä By Severity:
   - 0 Critical
   - 0 High
   - 1 Medium (inline)
   - 3 Low (1 inline, 1 fallback, 1 PR comment)

üîó View PR: https://github.com/microsoft/Agent365-Samples/pull/187

The review file has been updated to track posted comments.
```

## Error Handling

- **Review file not found**: Guide user to run `/review-pr <PR_NUMBER>` first
- **No PR number in review**: Inform user this skill only works with PR reviews, not staged reviews
- **GitHub CLI outdated**: If version < 2.40.0, attempt automatic upgrade first; if that fails, provide manual upgrade instructions and exit
- **EMU account detected**: If only EMU account is available, offer to guide user through `gh auth login` interactively; if that fails, provide manual instructions and exit
- **PR not accessible**: Check authentication with `gh auth status` and repo permissions
- **Missing HEAD commit**: If review file doesn't have HEAD Commit, fetch it from the PR; warn if PR has been updated
- **Inline comment fails**:
  - First analyze the error (line invalid, path not found, commit mismatch, body too long)
  - Attempt automatic fix if possible (re-fetch commit, recalculate lines, truncate body)
  - If unfixable, ask user: post as regular comment, skip, or cancel
  - Common causes: PR was rebased/updated, line numbers changed, file was renamed
- **Comment posting fails**: Retry once, then log the error and continue with remaining comments
- **Rate limiting**: If GitHub rate limits, wait and retry with exponential backoff

## Important Notes

- **Inline comments preferred**: When line information is available, always prefer inline comments for better code context
- **One comment per finding**: This makes it easy to track and resolve individual issues
- **Summary comment first**: Always post the summary before individual findings
- **Idempotency**: Check if comments were already posted (via the "GitHub Comments" section) to avoid duplicates
- **Respect rate limits**: Add small delays between posting multiple comments to avoid GitHub rate limiting
- **Keep inline comments concise**: Inline comments appear in the code review UI, so keep them focused. Save detailed explanations for the summary.
- **Smart error handling**: If inline posting fails, first try to fix automatically, then ask the user before falling back to regular PR comments
- **Keep comments concise**: GitHub has a 65536 character limit per comment; truncate diff context if needed
