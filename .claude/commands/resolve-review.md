# Resolve Review Comments

Automatically resolve code review comments that are marked as "Agent Resolvable: Yes" from a review generated by `/review-pr` or `/review-staged`.

## Usage

```
/resolve-review [REVIEW_FILE_PATH]
```

**Arguments:**
- `REVIEW_FILE_PATH` (optional) - Path to the review file. If omitted, uses the most recent review file in `.codereviews/`.

**Examples:**
- `/resolve-review` - Resolve comments from the most recent review
- `/resolve-review .codereviews/claude-pr123-20260124_143022.md` - Resolve specific review

## Instructions

You are resolving agent-resolvable code review comments. This skill supports two scenarios:
1. **PR Reviews**: Changes are made in a git worktree to avoid disrupting your current work
2. **Staged Reviews**: Changes are made directly in the current working directory after validation

### Step 1: Locate and Parse the Review File

1. If `$ARGUMENTS` is provided and non-empty, use that as the review file path
2. Otherwise, find the most recent review file:
   ```bash
   ls -t .codereviews/claude-*.md | head -1
   ```
   On Windows, use:
   ```bash
   Get-ChildItem .codereviews/claude-*.md | Sort-Object LastWriteTime -Descending | Select-Object -First 1 -ExpandProperty FullName
   ```
3. Read the review file and extract:
   - **Review type**: PR review (contains "PR Number:") or staged review (contains "Review Type: Pre-commit")
   - **PR number** (if PR review): Extract from the metadata
   - **All findings marked "Agent Resolvable: Yes"**: Parse the structured issues

4. If no resolvable issues are found, inform the user and exit.

5. Create a todo list tracking each resolvable issue to be fixed.

### Step 2: Environment Setup (Branching Strategy)

**For PR Reviews (use git worktree for isolation):**

Git worktree allows you to work on a different branch without changing your current working directory. This is critical to avoid disrupting the user's in-progress work.

1. Get the PR's head branch name:
   ```bash
   gh pr view <PR_NUMBER> --json headRefName --jq '.headRefName'
   ```

2. Fetch the latest from origin:
   ```bash
   git fetch origin
   ```

3. Create a worktree directory:
   ```bash
   mkdir -p .worktrees
   ```

4. Find an available branch name for the fixes:
   - Start with `code-review-fixes/pr-<PR_NUMBER>`
   - If it exists (check with `git branch -a | grep <name>`), try `-v2`, `-v3`, etc.

5. Create a worktree with the new branch based on the PR branch:
   ```bash
   git worktree add .worktrees/pr-<PR_NUMBER>-fixes -b <FIX_BRANCH_NAME> origin/<PR_HEAD_BRANCH>
   ```

6. **CRITICAL**: All subsequent file reads, edits, and git operations for fixes must happen in the worktree directory (`.worktrees/pr-<PR_NUMBER>-fixes/`), NOT the main repository.

**For Staged Reviews (work in current directory):**

1. Validate the environment is still appropriate:
   ```bash
   # Check we have staged changes
   git diff --cached --name-only
   ```

2. If no staged changes exist:
   - The user may have already committed. Ask if they want to continue anyway.
   - If the review was for specific files, verify those files exist.

3. Get the current branch name for reference:
   ```bash
   git branch --show-current
   ```

4. Work directly in the current repository directory.

### Step 3: Resolve Issues Iteratively

For each issue marked "Agent Resolvable: Yes":

1. **Analyze the issue**:
   - Read the file mentioned in the finding (remember: use worktree path for PR reviews!)
   - Understand the description and suggested fix
   - Review the diff context provided in the review

2. **Implement the fix**:
   - Follow the coding standards from CLAUDE.md
   - Make minimal, focused changes that address exactly what was identified
   - Use the Edit tool to make changes

3. **Verify the fix** (language-specific):

   **For C# (.cs) files:**
   ```bash
   dotnet build <path-to-csproj-or-sln>
   ```

   **For Python (.py) files:**
   ```bash
   # If uv is available
   uv run --frozen ruff check <file>
   uv run --frozen ruff format --check <file>
   # Otherwise
   python -m py_compile <file>
   ```

   **For TypeScript (.ts) files:**
   ```bash
   cd <sample-directory>
   npm run build
   ```

   **For JavaScript (.js) files:**
   ```bash
   # Syntax check only
   node --check <file>
   ```

4. **Commit the fix** (one commit per issue for clear history):
   ```bash
   git add <file>
   git commit -m "$(cat <<'EOF'
   fix(<scope>): address review comment CRM-XXX

   <Brief description of the fix>

   Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
   EOF
   )"
   ```

5. **Update the todo list** - mark the issue as completed

6. **Update the review file** (in the MAIN repository, not worktree):
   - Change `- [ ] No` to `- [x] Yes` for the Resolved field
   - Update the Resolution field with the commit hash and brief description

### Step 4: Finalization

**For PR Reviews:**

1. Push the fix branch to origin:
   ```bash
   cd .worktrees/pr-<PR_NUMBER>-fixes
   git push -u origin <FIX_BRANCH_NAME>
   ```

2. Create a PR to merge fixes into the original PR branch:
   ```bash
   gh pr create --base <ORIGINAL_PR_HEAD_BRANCH> --head <FIX_BRANCH_NAME> --title "fix: address code review comments for PR #<PR_NUMBER>" --body "$(cat <<'EOF'
   ## Summary
   Addresses agent-resolvable code review comments from PR #<PR_NUMBER>.

   ## Comments Resolved
   - CRM-XXX: <description>
   - CRM-YYY: <description>

   ## Review File
   See `.codereviews/<review-file-name>` for full details.

   Generated with [Claude Code](https://claude.com/claude-code)
   EOF
   )"
   ```

3. Clean up the worktree:
   ```bash
   cd <ORIGINAL_REPO_ROOT>
   git worktree remove .worktrees/pr-<PR_NUMBER>-fixes
   ```

4. Optionally clean up the worktree directory if empty:
   ```bash
   rmdir .worktrees 2>/dev/null || true
   ```

**For Staged Reviews:**

1. Inform the user that fixes have been applied to their staged changes
2. The changes are now in their working directory (some staged, some unstaged)
3. Suggest they review the changes with `git diff` and `git diff --cached`
4. Suggest they run tests before committing:
   - **C#**: `dotnet test <path-to-test-project>`
   - **Python**: `pytest tests/ -v --tb=short` or `uv run --frozen pytest`
   - **Node.js**: `npm test`

### Step 5: Report Results

Provide a summary including:

1. **Issues resolved**: List each CRM-XXX with brief description
2. **Issues skipped** (if any): Explain why certain "Agent Resolvable" issues couldn't be automatically fixed
3. **For PR reviews**:
   - The fix PR URL
   - Note that the worktree has been cleaned up
4. **For staged reviews**:
   - Remind user to review changes with `git diff`
   - Remind user to run tests before committing
5. **Updated review file path**: So user can see the resolution status

## Error Handling

- **Worktree creation fails**: May indicate branch already exists or git state issues. Clean up with `git worktree prune` and retry.
- **Push fails**: Check for branch protection rules or authentication issues.
- **File not found in worktree**: The PR may have been rebased. Suggest user re-run the review on the updated PR.
- **Build/lint fails repeatedly**: Some fixes may require human judgment. Mark as partially resolved and note in the summary.

## Important Notes

- **Never modify files in the main repository when working on PR reviews** - always use the worktree path
- **Always update the review file in the main repository** - this tracks progress regardless of which mode
- **Each fix gets its own commit** - this makes it easy to review and revert individual changes
- **Follow CLAUDE.md coding standards** - especially copyright headers, no "Kairo" keyword, sample independence
- **Worktrees are temporary** - always clean them up after creating the fix PR
- **Multi-language repository** - verify fixes with the appropriate language toolchain (dotnet, npm, python)
