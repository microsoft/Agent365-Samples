# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

name: Update E2E Status

on:
  workflow_run:
    workflows: ["E2E Agent Samples"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-status:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get job statuses
        id: get-status
        uses: actions/github-script@v7
        with:
          script: |
            // Get the triggering workflow run or latest run
            let runId;
            if (context.payload.workflow_run) {
              runId = context.payload.workflow_run.id;
            } else {
              // Manual trigger - get latest run
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'e2e-agent-samples.yml',
                branch: 'main',
                per_page: 1
              });
              if (runs.data.workflow_runs.length === 0) {
                console.log('No workflow runs found');
                core.setOutput('found', 'false');
                return;
              }
              runId = runs.data.workflow_runs[0].id;
            }
            
            console.log(`Processing workflow run: ${runId}`);
            core.setOutput('run-id', runId);
            core.setOutput('run-url', `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`);
            
            // Get jobs for this run
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });
            
            // Map job names to their status
            const jobStatusMap = {
              'Python OpenAI Agent': 'python-openai',
              'Node.js OpenAI Agent': 'nodejs-openai',
              '.NET Semantic Kernel Agent': 'dotnet-sk',
              '.NET Agent Framework Agent': 'dotnet-af'
            };
            
            let jobsFound = 0;
            for (const job of jobs.data.jobs) {
              const key = jobStatusMap[job.name];
              if (key) {
                const conclusion = job.conclusion || job.status || 'unknown';
                core.setOutput(key, conclusion);
                console.log(`${job.name}: ${conclusion}`);
                jobsFound++;
              }
            }
            
            if (jobsFound > 0) {
              core.setOutput('found', 'true');
              core.setOutput('date', new Date().toISOString().split('T')[0]);
            } else {
              console.log('No matching jobs found');
              core.setOutput('found', 'false');
            }

      - name: Update README
        if: steps.get-status.outputs.found == 'true'
        env:
          PYTHON_STATUS: ${{ steps.get-status.outputs.python-openai }}
          NODEJS_STATUS: ${{ steps.get-status.outputs.nodejs-openai }}
          DOTNET_SK_STATUS: ${{ steps.get-status.outputs.dotnet-sk }}
          DOTNET_AF_STATUS: ${{ steps.get-status.outputs.dotnet-af }}
          RUN_URL: ${{ steps.get-status.outputs.run-url }}
          UPDATE_DATE: ${{ steps.get-status.outputs.date }}
        run: |
          python3 << 'EOF'
          import os
          import re
          import textwrap
          from urllib.parse import quote
          
          def create_badge(name, status):
              encoded_name = quote(name, safe='')
              if status == 'success':
                  return f'![{name}](https://img.shields.io/badge/{encoded_name}-passing-brightgreen)'
              elif status == 'failure':
                  return f'![{name}](https://img.shields.io/badge/{encoded_name}-failing-red)'
              elif status == 'in_progress':
                  return f'![{name}](https://img.shields.io/badge/{encoded_name}-running-yellow)'
              else:
                  return f'![{name}](https://img.shields.io/badge/{encoded_name}-unknown-lightgrey)'
          
          python_badge = create_badge('Python OpenAI', os.environ.get('PYTHON_STATUS') or 'unknown')
          nodejs_badge = create_badge('Node.js OpenAI', os.environ.get('NODEJS_STATUS') or 'unknown')
          dotnet_sk_badge = create_badge('.NET SK', os.environ.get('DOTNET_SK_STATUS') or 'unknown')
          dotnet_af_badge = create_badge('.NET AF', os.environ.get('DOTNET_AF_STATUS') or 'unknown')
          run_url = os.environ.get('RUN_URL') or '#'
          update_date = os.environ.get('UPDATE_DATE') or 'unknown'
          
          new_section = f'''## E2E Test Status

          | Sample | Status |
          |--------|--------|
          | Python OpenAI | {python_badge} |
          | Node.js OpenAI | {nodejs_badge} |
          | .NET Semantic Kernel | {dotnet_sk_badge} |
          | .NET Agent Framework | {dotnet_af_badge} |

          *Last updated: {update_date} | [View Run]({run_url})*

          '''
          
          # Remove leading spaces from heredoc while preserving blank lines
          new_section = textwrap.dedent(new_section)
          
          with open('README.md', 'r') as f:
              content = f.read()
          
          # Pattern to match the E2E Test Status section until the next section
          pattern = r'## E2E Test Status\n.*?(?=\n> ####|\n## (?!E2E Test Status)|\Z)'
          
          if re.search(pattern, content, re.DOTALL):
              content = re.sub(pattern, new_section, content, flags=re.DOTALL)
              with open('README.md', 'w') as f:
                  f.write(content)
              print('README updated successfully')
          else:
              print('E2E Test Status section not found')
          EOF

      - name: Commit and push changes
        if: steps.get-status.outputs.found == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --staged --quiet || (git commit -m "chore: Update E2E test status [skip ci]" && git push)
