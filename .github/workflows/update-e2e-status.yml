# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

name: Update E2E Status

on:
  workflow_run:
    workflows: ["E2E Agent Samples"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-status:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get job statuses and update README
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Get the triggering workflow run or latest run
            let runId;
            if (context.payload.workflow_run) {
              runId = context.payload.workflow_run.id;
            } else {
              // Manual trigger - get latest run
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'e2e-agent-samples.yml',
                branch: 'main',
                per_page: 1
              });
              if (runs.data.workflow_runs.length === 0) {
                console.log('No workflow runs found');
                return;
              }
              runId = runs.data.workflow_runs[0].id;
            }
            
            console.log(`Processing workflow run: ${runId}`);
            
            // Get jobs for this run
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });
            
            // Map job names to their status badges
            const jobStatusMap = {
              'Python OpenAI Agent': { key: 'python-openai', label: 'Python OpenAI' },
              'Node.js OpenAI Agent': { key: 'nodejs-openai', label: 'Node.js OpenAI' },
              '.NET Semantic Kernel Agent': { key: 'dotnet-sk', label: '.NET Semantic Kernel' },
              '.NET Agent Framework Agent': { key: 'dotnet-af', label: '.NET Agent Framework' }
            };
            
            const statuses = {};
            for (const job of jobs.data.jobs) {
              const mapping = jobStatusMap[job.name];
              if (mapping) {
                const conclusion = job.conclusion || job.status;
                let badge;
                if (conclusion === 'success') {
                  badge = `![${mapping.label}](https://img.shields.io/badge/${encodeURIComponent(mapping.label)}-passing-brightgreen)`;
                } else if (conclusion === 'failure') {
                  badge = `![${mapping.label}](https://img.shields.io/badge/${encodeURIComponent(mapping.label)}-failing-red)`;
                } else if (conclusion === 'in_progress' || job.status === 'in_progress') {
                  badge = `![${mapping.label}](https://img.shields.io/badge/${encodeURIComponent(mapping.label)}-running-yellow)`;
                } else {
                  badge = `![${mapping.label}](https://img.shields.io/badge/${encodeURIComponent(mapping.label)}-pending-lightgrey)`;
                }
                statuses[mapping.key] = badge;
                console.log(`${job.name}: ${conclusion} -> ${badge}`);
              }
            }
            
            // Read current README
            let readme = fs.readFileSync('README.md', 'utf8');
            
            // Generate new status table
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            const newTable = `## E2E Test Status

| Sample | Status |
|--------|--------|
| Python OpenAI | ${statuses['python-openai'] || '![Python OpenAI](https://img.shields.io/badge/Python%20OpenAI-unknown-lightgrey)'} |
| Node.js OpenAI | ${statuses['nodejs-openai'] || '![Node.js OpenAI](https://img.shields.io/badge/Node.js%20OpenAI-unknown-lightgrey)'} |
| .NET Semantic Kernel | ${statuses['dotnet-sk'] || '![.NET SK](https://img.shields.io/badge/.NET%20SK-unknown-lightgrey)'} |
| .NET Agent Framework | ${statuses['dotnet-af'] || '![.NET AF](https://img.shields.io/badge/.NET%20AF-unknown-lightgrey)'} |

*Last updated: ${new Date().toISOString().split('T')[0]} | [View Run](${runUrl})*`;
            
            // Replace the status section
            const statusRegex = /## E2E Test Status[\s\S]*?\n(?=\n>|$)/;
            if (statusRegex.test(readme)) {
              readme = readme.replace(statusRegex, newTable + '\n');
            }
            
            fs.writeFileSync('README.md', readme);
            console.log('README updated successfully');

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --staged --quiet || (git commit -m "chore: Update E2E test status [skip ci]" && git push)
